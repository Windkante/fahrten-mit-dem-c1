<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fahrtenbuch C1</title>

<link rel="stylesheet"
 href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#f6f7f9;
  --card:#fff;
  --text:#111;
  --muted:#666;
  --accent:#0a84ff;
  --radius:18px;
}
html.dark{
  --bg:#121212;
  --card:#1e1e1e;
  --text:#fff;
  --muted:#aaa;
}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:var(--text);
}
.hero{
  height:220px;
  background:url("c1-header.jpg") center/cover no-repeat;
}
.hero h1{
  margin:0;
  padding:20px;
  color:white;
  font-size:28px;
  text-shadow:0 4px 20px rgba(0,0,0,.6);
}
main{
  max-width:560px;
  margin:auto;
  padding:16px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
}
button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:none;
  font-size:16px;
  background:var(--accent);
  color:white;
  margin-top:8px;
}
button.secondary{background:#777}
select{width:100%;padding:10px;font-size:16px}
#map{height:260px;border-radius:14px}
.trip{border-bottom:1px solid #ddd;padding:8px 0}
canvas{width:100%;height:220px}
</style>
</head>

<body>
<div class="hero"><h1>Fahrtenbuch C1</h1></div>

<main>

<div class="card">
<label>Fahrer</label>
<select id="driver">
<option>Felipe</option>
<option>Claudia</option>
<option>Christian</option>
</select>
</div>

<div class="card">
<button id="startBtn">â–¶ Fahrt starten</button>
<button id="endBtn" class="secondary">â–  Fahrt beenden</button>
</div>

<div class="card" id="status">Keine aktive Fahrt</div>

<div class="card">
<label>Monat</label>
<select id="monthSelect"></select>
</div>

<div class="card">
<h3>Auswertung</h3>
<div id="stats"></div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>Karte</h3>
<div id="map"></div>
</div>

<div class="card">
<h3>Fahrten</h3>
<div id="tripList"></div>
</div>

<div class="card">
<button class="secondary" id="darkBtn">ðŸŒ™ Dark Mode</button>
</div>

</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let trips=JSON.parse(localStorage.getItem("c1Trips"))||[];
let currentTrip=null,watchId=null;

const months=["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
months.forEach((m,i)=>{
  monthSelect.innerHTML+=`<option value="${i}">${m}</option>`;
});
monthSelect.value=new Date().getMonth();

darkBtn.onclick=()=>document.documentElement.classList.toggle("dark");

function dist(a,b){
  const R=6371e3;
  const dÏ†=(b.lat-a.lat)*Math.PI/180;
  const dÎ»=(b.lon-a.lon)*Math.PI/180;
  const x=Math.sin(dÏ†/2)**2+
  Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
  Math.sin(dÎ»/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

startBtn.onclick=()=>{
  if(!navigator.geolocation){
    alert("GPS nicht verfÃ¼gbar");
    return;
  }
  currentTrip={
    driver:driver.value,
    start:Date.now(),
    pts:[],
    dist:0
  };
  watchId=navigator.geolocation.watchPosition(pos=>{
    const p={lat:pos.coords.latitude,lon:pos.coords.longitude};
    if(currentTrip.pts.length)
      currentTrip.dist+=dist(currentTrip.pts.at(-1),p);
    currentTrip.pts.push(p);
    status.innerText=`Fahrt lÃ¤uftâ€¦ ${(currentTrip.dist/1000).toFixed(2)} km`;
  });
};

endBtn.onclick=()=>{
  if(!currentTrip)return;
  navigator.geolocation.clearWatch(watchId);
  currentTrip.end=Date.now();
  currentTrip.min=Math.round((currentTrip.end-currentTrip.start)/60000);
  currentTrip.km=(currentTrip.dist/1000).toFixed(2);
  trips.unshift(currentTrip);
  localStorage.setItem("c1Trips",JSON.stringify(trips));
  currentTrip=null;
  status.innerText="Fahrt beendet";
  render();
};

const ctx=chart.getContext("2d");
let map=L.map("map").setView([48,11],6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let route;

function render(){
  const y=new Date().getFullYear();
  const m=parseInt(monthSelect.value);
  const f=trips.filter(t=>{
    const d=new Date(t.start);
    return d.getMonth()===m&&d.getFullYear()===y;
  });

  const agg={Felipe:0,Claudia:0,Christian:0};
  f.forEach(t=>agg[t.driver]+=parseFloat(t.km));
  const total=Object.values(agg).reduce((a,b)=>a+b,0)||1;

  stats.innerHTML=Object.entries(agg).map(([d,v])=>
    `<strong>${d}</strong>: ${v.toFixed(1)} km (${(v/total*100).toFixed(1)}%)`
  ).join("<br>");

  ctx.clearRect(0,0,chart.width,chart.height);
  const max=Math.max(...Object.values(agg))||1;
  Object.keys(agg).forEach((k,i)=>{
    const h=agg[k]/max*(chart.height-30);
    ctx.fillStyle="#0a84ff";
    ctx.fillRect(i*120+20,chart.height-h-10,60,h);
    ctx.fillText(k,i*120+20,chart.height-2);
  });

  if(route){map.removeLayer(route);}
  const pts=f.flatMap(t=>t.pts||[]);
  if(pts.length){
    route=L.polyline(pts.map(p=>[p.lat,p.lon]),{color:"#0a84ff"}).addTo(map);
    map.fitBounds(route.getBounds());
  }

  tripList.innerHTML=f.map(t=>
    `<div class="trip">${new Date(t.start).toLocaleDateString()} â€“
     <strong>${t.driver}</strong><br>${t.km} km Â· ${t.min} Min</div>`
  ).join("")||"Keine Fahrten";
}

monthSelect.onchange=render;
render();
</script>
</body>
</html>
