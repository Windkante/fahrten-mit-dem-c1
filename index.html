<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fahrtenbuch C1</title>

<style>
:root{
  --bg:#f6f7f9;--card:#fff;--text:#111;--muted:#666;
  --accent:#0a84ff;--radius:18px
}
html.dark{--bg:#121212;--card:#1e1e1e;--text:#fff;--muted:#aaa}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.hero{height:220px;background:url("c1-header.jpg") center/cover}
.hero h1{margin:0;padding:20px;color:#fff;font-size:28px;
text-shadow:0 4px 20px rgba(0,0,0,.6)}
main{max-width:520px;margin:auto;padding:16px}
.card{background:var(--card);border-radius:var(--radius);
padding:16px;margin-bottom:16px;
box-shadow:0 12px 30px rgba(0,0,0,.08)}
button{width:100%;padding:14px;border-radius:14px;
border:none;font-size:16px;background:var(--accent);
color:#fff;margin-top:8px}
button.secondary{background:#777}
select{width:100%;padding:10px;font-size:16px}
canvas{width:100%;height:240px}
.small{font-size:14px;color:var(--muted)}
.trip{border-bottom:1px solid #ddd;padding:8px 0}
</style>
</head>

<body>
<div class="hero"><h1>Fahrtenbuch C1</h1></div>

<main>

<div class="card">
<label>Fahrer</label>
<select id="driver">
<option>Felipe</option>
<option>Claudia</option>
<option>Christian</option>
</select>
</div>

<div class="card">
<button id="startBtn">â–¶ Fahrt starten</button>
<button id="endBtn" class="secondary">â–  Fahrt beenden</button>
</div>

<div class="card" id="status">Keine aktive Fahrt</div>

<div class="card">
<label>Monat</label>
<select id="monthSelect"></select>
</div>

<div class="card">
<h3>Auswertung</h3>
<div id="stats"></div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

<div class="card">
<h3>Fahrten</h3>
<div id="tripList"></div>
</div>

<div class="card">
<button class="secondary" id="darkBtn">ðŸŒ™ Dark Mode</button>
</div>

</main>

<script>
/* ===== STATE ===== */
let trips=JSON.parse(localStorage.getItem("c1Trips"))||[];
let currentTrip=null,watchId=null;
const drivers=["Felipe","Claudia","Christian"];

/* ===== ELEMENTE ===== */
const statusBox=status;
const tripList=document.getElementById("tripList");
const statsBox=document.getElementById("stats");
const canvas=document.getElementById("chart");
const ctx=canvas.getContext("2d");

/* ===== MONATE ===== */
const months=["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
const monthSelect=document.getElementById("monthSelect");
months.forEach((m,i)=>{
  const o=document.createElement("option");
  o.value=i;o.text=m;monthSelect.appendChild(o)
});
monthSelect.value=new Date().getMonth();

/* ===== DARK ===== */
darkBtn.onclick=()=>document.documentElement.classList.toggle("dark");

/* ===== DISTANZ ===== */
function dist(a,b){
  const R=6371e3;
  const dÏ†=(b.lat-a.lat)*Math.PI/180;
  const dÎ»=(b.lon-a.lon)*Math.PI/180;
  const x=Math.sin(dÏ†/2)**2+
  Math.cos(a.lat*Math.PI/180)*
  Math.cos(b.lat*Math.PI/180)*
  Math.sin(dÎ»/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))
}

/* ===== START ===== */
startBtn.onclick=()=>{
  if(!navigator.geolocation)return alert("GPS nicht verfÃ¼gbar");
  currentTrip={driver:driver.value,start:Date.now(),pts:[],dist:0};
  watchId=navigator.geolocation.watchPosition(p=>{
    const pos={lat:p.coords.latitude,lon:p.coords.longitude};
    const pts=currentTrip.pts;
    if(pts.length)currentTrip.dist+=dist(pts.at(-1),pos);
    pts.push(pos);
    statusBox.innerText=`Fahrt lÃ¤uftâ€¦ ${(currentTrip.dist/1000).toFixed(2)} km`
  })
}

/* ===== ENDE ===== */
endBtn.onclick=()=>{
  if(!currentTrip)return;
  navigator.geolocation.clearWatch(watchId);
  currentTrip.end=Date.now();
  currentTrip.min=Math.round((currentTrip.end-currentTrip.start)/60000);
  currentTrip.km=(currentTrip.dist/1000).toFixed(2);
  trips.unshift(currentTrip);
  localStorage.setItem("c1Trips",JSON.stringify(trips));
  currentTrip=null;
  statusBox.innerText="Fahrt beendet";
  render();
}

/* ===== RENDER ===== */
function render(){
  const m=parseInt(monthSelect.value);
  const year=new Date().getFullYear();
  const filtered=trips.filter(t=>{
    const d=new Date(t.start);
    return d.getMonth()===m&&d.getFullYear()===year
  });

  const agg={};
  drivers.forEach(d=>agg[d]={km:0});
  filtered.forEach(t=>agg[t.driver].km+=parseFloat(t.km));

  const total=Object.values(agg).reduce((a,b)=>a+b.km,0)||1;
  statsBox.innerHTML=drivers.map(d=>{
    const p=(agg[d].km/total*100).toFixed(1);
    return `<strong>${d}</strong>: ${agg[d].km.toFixed(1)} km (${p}%)`
  }).join("<br>");

  drawChart(agg);
  tripList.innerHTML=filtered.map(t=>{
    const d=new Date(t.start);
    return `<div class="trip">
    ${d.toLocaleDateString()} â€“ <strong>${t.driver}</strong><br>
    ${t.km} km Â· ${t.min} Min
    </div>`
  }).join("")||"<span class='small'>Keine Fahrten</span>";
}

/* ===== CHART ===== */
function drawChart(data){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const max=Math.max(...drivers.map(d=>data[d].km))||1;
  drivers.forEach((d,i)=>{
    const h=data[d].km/max*(canvas.height-30);
    ctx.fillStyle="#0a84ff";
    ctx.fillRect(i*120+20,canvas.height-h-10,60,h);
    ctx.fillStyle="#888";
    ctx.fillText(d,i*120+20,canvas.height-2)
  })
}

monthSelect.onchange=render;
render();
</script>
</body>
</html>
