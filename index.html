<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fahrten mit dem C1</title>

<meta name="color-scheme" content="light dark">

<style>
:root {
  --bg: #ffffff;
  --text: #000000;
  --card: #f2f2f2;
  --accent: #0a84ff;
}

html.dark {
  --bg: #121212;
  --text: #ffffff;
  --card: #1e1e1e;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  padding: 16px;
  background: var(--card);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

main {
  padding: 16px;
}

.card {
  background: var(--card);
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 16px;
}

button {
  padding: 12px 16px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: white;
}

button.secondary {
  background: #555;
}

select {
  padding: 8px;
  font-size: 16px;
}
</style>
</head>

<body>

<header>
  <strong>üöó Fahrten mit dem C1</strong>
  <button class="secondary" onclick="toggleDark()">üåô</button>
</header>

<main>

<div class="card">
  <label>Fahrer:</label><br>
  <select id="driver">
    <option>Felipe</option>
    <option>Claudia</option>
    <option>Christian</option>
  </select>
</div>

<div class="card">
  <button onclick="startTrip()">‚ñ∂ Fahrt starten</button>
  <button onclick="endTrip()">‚èπ Fahrt beenden</button>
</div>

<div class="card" id="status">
  Keine aktive Fahrt
</div>

<div class="card">
  <h3>Auswertung (gesamt)</h3>
  <div id="stats"></div>
</div>

</main>

<script>
/* ===== Dark Mode ===== */
function toggleDark() {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("theme",
    document.documentElement.classList.contains("dark") ? "dark" : "light"
  );
}
if (localStorage.getItem("theme") === "dark") {
  document.documentElement.classList.add("dark");
}

/* ===== Fahrten-Daten ===== */
let trips = JSON.parse(localStorage.getItem("c1Trips")) || [];
let currentTrip = null;
let watchId = null;

/* ===== Distanzberechnung ===== */
function distance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ===== Fahrt starten ===== */
function startTrip() {
  alert("startTrip erreicht");

  if (currentTrip) return;

  currentTrip = {
    driver: document.getElementById("driver").value,
    start: Date.now(),
    distance: 0,
    lastPos: null
  };

  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;
    if (currentTrip.lastPos) {
      currentTrip.distance += distance(
        currentTrip.lastPos.lat,
        currentTrip.lastPos.lon,
        latitude,
        longitude
      );
    }
    currentTrip.lastPos = { lat: latitude, lon: longitude };
  });

  document.getElementById("status").innerText = "Fahrt l√§uft‚Ä¶";
}

/* ===== Fahrt beenden ===== */
function endTrip() {
  if (!currentTrip) return;

  navigator.geolocation.clearWatch(watchId);

  currentTrip.end = Date.now();
  trips.push(currentTrip);
  localStorage.setItem("c1Trips", JSON.stringify(trips));

  currentTrip = null;
  document.getElementById("status").innerText = "Fahrt beendet";
  updateStats();
}

/* ===== Auswertung ===== */
function updateStats() {
  let text = "";
  const byDriver = {};

  trips.forEach(t => {
    byDriver[t.driver] ??= { km: 0, count: 0 };
    byDriver[t.driver].km += t.distance;
    byDriver[t.driver].count++;
  });

  for (const d in byDriver) {
    text += `${d}: ${byDriver[d].count} Fahrten, ${byDriver[d].km.toFixed(1)} km<br>`;
  }

  document.getElementById("stats").innerHTML = text || "Noch keine Fahrten";
}

updateStats();
</script>

</body>
</html>

